<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      #map {
        height: 600px;
        width: 100%;
      }
    </style>
</head>

<body>
    <h2>NASA EONET の最新イベント (GIBS 衛星画像)</h2>
    <div id="event"></div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const EONET_URL = "https://eonet.gsfc.nasa.gov/api/v3/events";

        async function getEonetEvents() {
            const response = await fetch(EONET_URL);
            const data = await response.json();
            return data;
        }

        function initMap(lat, lon, eventName) {
            // Leaflet地図を作成
            const map = L.map("map").setView([lat, lon], 4);

            // NASA GIBS の MODIS True Color (日次更新) タイルを背景に設定
            //const today = new Date().toISOString().split("T")[0]; // 今日の日付を YYYY-MM-DD 形式で取得
            const today = '2025-09-01';

            L.tileLayer(
                `https://gibs.earthdata.nasa.gov/wmts/epsg3857/best/MODIS_Terra_CorrectedReflectance_TrueColor/default/${today}/GoogleMapsCompatible_Level9/{z}/{y}/{x}.jpg`,
                {
                    attribution: "Imagery courtesy NASA GIBS",
                    tileSize: 256,
                    minZoom: 1,
                    maxZoom: 9
                }
            ).addTo(map);

            // イベント位置にマーカーを追加
            L.marker([lat, lon]).addTo(map)
                .bindPopup(eventName)
                .openPopup();
        }

        async function main() {
            try {
                const eventsData = await getEonetEvents();
                if (eventsData.events.length > 0) {
                    const firstEvent = eventsData.events[0];
                    const coords = firstEvent.geometry[0].coordinates;
                    const lon = coords[0];
                    const lat = coords[1];
                    const name = firstEvent.title;

                    document.getElementById("event").textContent =
                        `イベント: ${name} (lat: ${lat}, lon: ${lon})`;

                    initMap(lat, lon, name);
                } else {
                    document.getElementById("event").textContent = "イベントが見つかりませんでした。";
                }
            } catch (err) {
                console.error(err);
                document.getElementById("event").textContent = "データ取得エラー";
            }
        }

        main();
    </script>
</body>

</html>